<section id="xtv-timeclock" style="font-family:'Inter',sans-serif;background:#fff;color:#0f172a;padding:28px 16px;">

  <!-- html2pdf (PDF download; has print fallback if blocked by host) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"
    integrity="sha512-GsLlZN/3F2ErC5ifS5QtgpiJtWd43JWSuIgh7mbzZ8zBps+dvLusV+eNQATqgA/HdeKFVgA5v3S/cIrLF7QnIg=="
    crossorigin="anonymous" referrerpolicy="no-referrer"></script>

  <style>
    #xtv-timeclock .kicker{display:inline-block;padding:10px 20px;border-radius:999px;background:linear-gradient(135deg,#0072ff,#00c6ff);color:#fff;font-weight:800;font-size:20px;margin:0 0 10px;}
    #xtv-timeclock h3{font-weight:800;font-size:22px;margin:10px 0 14px;}
    #xtv-timeclock .muted{color:#64748b;font-size:14px}
    #xtv-timeclock .wrap{max-width:1200px;margin:0 auto}

    /* Controls */
    #xtv-timeclock .bar{display:flex;flex-wrap:wrap;gap:8px;align-items:center;justify-content:space-between;margin:10px 0 14px}
    #xtv-timeclock .btn{background:linear-gradient(90deg,#0072ff,#00c6ff);color:#fff;border:none;border-radius:999px;padding:8px 14px;font-weight:700;cursor:pointer;transition:transform .2s,box-shadow .2s;font-size:14px}
    #xtv-timeclock .btn:hover{transform:translateY(-1px);box-shadow:0 6px 18px rgba(0,0,0,.12)}
    #xtv-timeclock .btn.alt{background:#e2e8f0;color:#0f172a}
    #xtv-timeclock input, #xtv-timeclock select, #xtv-timeclock textarea{border:1px solid #e2e8f0;border-radius:10px;padding:8px 10px;font-size:14px;outline:none}
    #xtv-timeclock input:focus, #xtv-timeclock select:focus, #xtv-timeclock textarea:focus{box-shadow:0 0 0 2px #93c5fd;border-color:#60a5fa}

    /* Table */
    #xtv-timeclock .table-wrap{overflow:auto;border:1px solid #e5e7eb;border-radius:16px}
    #xtv-timeclock table{width:100%;border-collapse:collapse;font-size:14px;min-width:1100px}
    #xtv-timeclock thead th{position:sticky;top:0;background:#f1f5f9;border-bottom:1px solid #e5e7eb;padding:10px;text-align:center;white-space:nowrap}
    #xtv-timeclock tbody td{border-top:1px solid #f1f5f9;padding:8px;vertical-align:middle}
    #xtv-timeclock tbody td input, #xtv-timeclock tbody td textarea, #xtv-timeclock tbody td select{width:100%;border:1px solid #e2e8f0;border-radius:8px;padding:6px 8px;font-size:13px}
    #xtv-timeclock .del{background:#ef4444;color:#fff;border:none;border-radius:8px;padding:6px 10px;cursor:pointer;font-weight:700}
    #xtv-timeclock .del:hover{background:#dc2626}
    #xtv-timeclock .miniWrap{display:flex;flex-direction:column;gap:6px}
    #xtv-timeclock .miniBtns{display:flex;gap:6px;flex-wrap:wrap}
    #xtv-timeclock .mini{padding:4px 8px;font-size:12px;border-radius:999px;border:none;background:#e2e8f0;color:#0f172a;cursor:pointer}
    #xtv-timeclock .mini.blue{background:linear-gradient(90deg,#0072ff,#00c6ff);color:#fff}
    #xtv-timeclock .badge{display:inline-block;font-size:11px;padding:2px 6px;border-radius:999px;background:#e5f2ff;color:#0b4ab0;margin-left:6px}

    /* Totals */
    #xtv-timeclock .totals{margin-top:14px;display:grid;grid-template-columns:repeat(3,1fr);gap:10px}
    #xtv-timeclock .card{border:1px solid #e5e7eb;border-radius:14px;padding:12px;background:#f9fafb;text-align:left}
    #xtv-timeclock .card h4{margin:0 0 6px;font-size:15px;font-weight:800}
    #xtv-timeclock .row{display:flex;justify-content:space-between;font-size:13px;color:#334155}

    /* Modal (Invoice) */
    #xtv-timeclock .modal{position:fixed;inset:0;background:rgba(15,23,42,.6);display:none;align-items:center;justify-content:center;padding:16px;z-index:99999}
    #xtv-timeclock .modal .box{width:min(900px,95vw);background:#fff;border-radius:16px;padding:16px 16px 20px;max-height:90vh;overflow:auto}
    #xtv-timeclock .modal h3{margin:6px 0 10px}
    #xtv-timeclock .grid2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    #xtv-timeclock .stack{display:flex;flex-direction:column;gap:6px}
    #xtv-timeclock .logoPreview{width:100px;height:100px;object-fit:contain;border:1px dashed #e5e7eb;border-radius:12px;background:#f8fafc}
    #xtv-timeclock .actions{display:flex;flex-wrap:wrap;gap:8px;justify-content:flex-end;margin-top:10px}
    #xtv-timeclock .sum{display:flex;gap:8px;justify-content:flex-end;margin-top:10px}
    #xtv-timeclock .sum div{background:#f1f5f9;border-radius:10px;padding:8px 10px;font-weight:700}

    @media(max-width:1000px){ #xtv-timeclock .totals{grid-template-columns:1fr} #xtv-timeclock .grid2{grid-template-columns:1fr} }
    @media print{
      /* print only the invoice modal */
      body *{ visibility:hidden !important; }
      #xtv-timeclock .modal, #xtv-timeclock .modal *{ visibility:visible !important; }
      #xtv-timeclock .modal{ position:static; inset:auto; background:#fff; display:block !important; padding:0; }
      #xtv-timeclock .actions, #xtv-timeclock .bar, #xtv-timeclock .kicker, #xtv-timeclock h3:not(.invTitle){ display:none !important; }
      #xtv-timeclock .modal .box{ width:auto; max-height:none; overflow:visible; box-shadow:none; border:none; padding:0; }
    }
  </style>

  <div class="wrap">
    <div class="kicker">Time Clock & Invoice Builder</div>
    <h3>Track hours by Employee, Job & Location ‚Äî then invoice in one click</h3>
    <p class="muted">Use the date controls to switch days. Your entries and settings auto-save in this browser.</p>

    <!-- Top bar -->
    <div class="bar">
      <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap;">
        <button class="btn alt" id="tcPrev">&larr; Prev Day</button>
        <input type="date" id="tcDate" aria-label="Selected day">
        <button class="btn alt" id="tcNext">Next Day &rarr;</button>
      </div>
      <div style="display:flex;gap:8px;flex-wrap:wrap;">
        <button class="btn" id="tcAddRow">‚ûï Add Work Row</button>
        <button class="btn" id="tcAddPTO">‚ûï Add PTO Row</button>
        <button class="btn" id="tcCopy">üìã Copy Time Entries</button>
        <button class="btn" id="tcCopySummary">üìã Copy Summary</button>
        <button class="btn" id="tcInvoice">üßæ Generate Invoice</button>
      </div>
    </div>

    <!-- Entry Table -->
    <div class="table-wrap">
      <table id="tcTable" aria-label="Time entries">
        <thead>
          <tr>
            <th>Type</th>
            <th>Employee</th>
            <th>Job</th>
            <th>Location</th>
            <th>Time In</th>
            <th>Time Out</th>
            <th>Break (min) <span class="badge" title="Live stopwatch via Start/End">stopwatch</span></th>
            <th>Hours</th>
            <th>Notes</th>
            <th>Actions</th>
            <th></th>
          </tr>
        </thead>
        <tbody id="tcBody"></tbody>
      </table>
    </div>

    <!-- Totals by Employee (for selected day) -->
    <div style="margin-top:14px;">
      <h3 class="invTitle" style="font-size:18px;margin:0 0 8px;">Daily Totals by Employee</h3>
      <div class="totals" id="tcTotals"></div>
    </div>
  </div>

  <!-- Invoice Modal -->
  <div class="modal" id="tcModal" aria-modal="true" role="dialog">
    <div class="box" id="invoiceBox">
      <div style="display:flex;align-items:center;justify-content:space-between;gap:10px;">
        <h3 class="invTitle">Invoice</h3>
        <div class="actions">
          <button class="btn alt" id="tcClose">Close</button>
          <button class="btn" id="tcEmail">‚úâÔ∏è Email Invoice</button>
          <button class="btn" id="tcDownload">‚¨áÔ∏è Download PDF</button>
          <button class="btn" id="tcPrint">üñ®Ô∏è Print</button>
        </div>
      </div>

      <div class="grid2" style="margin-top:8px;">
        <div class="stack">
          <label><strong>Business Name</strong></label>
          <input id="invBiz" placeholder="Your business name">
          <label><strong>Business Address</strong></label>
          <textarea id="invBizAddr" rows="3" placeholder="Street, City, State, ZIP"></textarea>
          <div style="display:flex;gap:10px;align-items:center;">
            <img id="invLogoPrev" class="logoPreview" alt="Logo preview">
            <div class="stack" style="flex:1;">
              <label><strong>Logo (optional)</strong></label>
              <input type="file" id="invLogo" accept="image/*">
            </div>
          </div>
        </div>

        <div class="stack">
          <label><strong>Bill To (Client)</strong></label>
          <input id="invClient" placeholder="Client / Company">
          <label><strong>Client Address</strong></label>
          <textarea id="invClientAddr" rows="3" placeholder="Street, City, State, ZIP"></textarea>
          <label><strong>Client Email (for Email Invoice)</strong></label>
          <input id="invClientEmail" type="email" placeholder="client@email.com">
          <div style="display:flex;gap:10px;flex-wrap:wrap;">
            <div class="stack" style="flex:1;min-width:140px;">
              <label><strong>Invoice #</strong></label>
              <input id="invNumber" placeholder="e.g., 1001">
            </div>
            <div class="stack" style="flex:1;min-width:140px;">
              <label><strong>Date</strong></label>
              <input id="invDate" type="date">
            </div>
            <div class="stack" style="flex:1;min-width:140px;">
              <label><strong>Tax %</strong></label>
              <input id="invTax" type="number" step="0.01" placeholder="0">
            </div>
          </div>
        </div>
      </div>

      <div id="invLinesWrap" style="margin-top:12px;border:1px solid #e5e7eb;border-radius:12px;overflow:hidden;">
        <table style="width:100%;border-collapse:collapse;font-size:14px;">
          <thead>
            <tr style="background:#f1f5f9;">
              <th style="padding:10px;border-bottom:1px solid #e5e7eb;text-align:left;">Employee</th>
              <th style="padding:10px;border-bottom:1px solid #e5e7eb;text-align:left;">Job</th>
              <th style="padding:10px;border-bottom:1px solid #e5e7eb;text-align:left;">Location</th>
              <th style="padding:10px;border-bottom:1px solid #e5e7eb;text-align:left;">Type</th>
              <th style="padding:10px;border-bottom:1px solid #e5e7eb;text-align:right;">Hours</th>
              <th style="padding:10px;border-bottom:1px solid #e5e7eb;text-align:right;">Rate</th>
              <th style="padding:10px;border-bottom:1px solid #e5e7eb;text-align:right;">Amount</th>
            </tr>
          </thead>
          <tbody id="invBody"></tbody>
        </table>
      </div>

      <div class="sum">
        <div>Subtotal: $<span id="invSub">0.00</span></div>
        <div>Tax: $<span id="invTaxAmt">0.00</span></div>
        <div>Total: $<span id="invTotal">0.00</span></div>
      </div>
    </div>
  </div>

  <script>
  (function(){
    const LS_ENTRIES_KEY = 'xtv_tc_entries_v3';
    const LS_INVOICE_KEY = 'xtv_tc_invoice_settings_v3';

    const el = {
      date: document.getElementById('tcDate'),
      prev: document.getElementById('tcPrev'),
      next: document.getElementById('tcNext'),
      add: document.getElementById('tcAddRow'),
      addPTO: document.getElementById('tcAddPTO'),
      copy: document.getElementById('tcCopy'),
      copySummary: document.getElementById('tcCopySummary'),
      body: document.getElementById('tcBody'),
      totals: document.getElementById('tcTotals'),
      invoiceBtn: document.getElementById('tcInvoice'),

      modal: document.getElementById('tcModal'),
      close: document.getElementById('tcClose'),
      email: document.getElementById('tcEmail'),
      download: document.getElementById('tcDownload'),
      print: document.getElementById('tcPrint'),

      invBiz: document.getElementById('invBiz'),
      invBizAddr: document.getElementById('invBizAddr'),
      invLogo: document.getElementById('invLogo'),
      invLogoPrev: document.getElementById('invLogoPrev'),
      invClient: document.getElementById('invClient'),
      invClientAddr: document.getElementById('invClientAddr'),
      invClientEmail: document.getElementById('invClientEmail'),
      invNumber: document.getElementById('invNumber'),
      invDate: document.getElementById('invDate'),
      invTax: document.getElementById('invTax'),

      invBody: document.getElementById('invBody'),
      invSub: document.getElementById('invSub'),
      invTaxAmt: document.getElementById('invTaxAmt'),
      invTotal: document.getElementById('invTotal'),

      invoiceBox: document.getElementById('invoiceBox')
    };

    /* ---------- Date helpers ---------- */
    function toYYYYMMDD(d){
      const t=new Date(d.getFullYear(), d.getMonth(), d.getDate()); // local midnight
      const m=('0'+(t.getMonth()+1)).slice(-2), da=('0'+t.getDate()).slice(-2);
      return t.getFullYear()+'-'+m+'-'+da;
    }
    function loadDate(d){
      el.date.value = toYYYYMMDD(d||new Date());
      const rows = loadDay(el.date.value);
      if(rows.length===0){
        const blank=[newRowData(false)];
        saveDay(el.date.value, blank);
        renderTable(blank);
      }else{
        renderTable(rows);
      }
    }
    el.prev.addEventListener('click', ()=>{
      const d=new Date(el.date.value+'T00:00');
      d.setDate(d.getDate()-1);
      loadDate(d);
    });
    el.next.addEventListener('click', ()=>{
      const d=new Date(el.date.value+'T00:00');
      d.setDate(d.getDate()+1);
      loadDate(d);
    });
    el.date.addEventListener('change', ()=>loadDate(new Date(el.date.value+'T00:00')));

    /* ---------- Time helpers (12h) ---------- */
    function now12h(){
      const d=new Date();
      let h=d.getHours(), m=d.getMinutes();
      const ampm = h>=12?'PM':'AM';
      h = h%12; if(h===0) h=12;
      return `${h}:${('0'+m).slice(-2)} ${ampm}`;
    }
    function parse12h(str){
      if(!str) return null;
      const s=str.trim().toUpperCase().replace(/\s+/g,' ');
      const m=s.match(/^(\d{1,2})(?::(\d{2}))?\s*(AM|PM)$/);
      if(!m) return null;
      let h=parseInt(m[1],10), mm=parseInt(m[2]||'0',10), ap=m[3];
      if(h<1||h>12||mm<0||mm>59) return null;
      if(ap==='PM' && h!==12) h+=12;
      if(ap==='AM' && h===12) h=0;
      return h*60+mm;
    }
    function fmtHours(mins){ if(isNaN(mins)||mins<=0) return '0.00'; return (mins/60).toFixed(2); }
    function money(n){ return (Math.round(n*100)/100).toFixed(2); }

    /* ---------- Storage ---------- */
    function loadAll(){ try{return JSON.parse(localStorage.getItem(LS_ENTRIES_KEY)||'{}')}catch(e){return{}} }
    function saveAll(obj){ localStorage.setItem(LS_ENTRIES_KEY, JSON.stringify(obj)); }
    function loadDay(date){ const all=loadAll(); return all[date]||[]; }
    function saveDay(date, rows){ const all=loadAll(); all[date]=rows; saveAll(all); }

    function loadInvSettings(){ try{ return JSON.parse(localStorage.getItem(LS_INVOICE_KEY)||'{}'); }catch(e){ return {}; } }
    function saveInvSettings(s){ localStorage.setItem(LS_INVOICE_KEY, JSON.stringify(s)); }

    /* ---------- Rows ---------- */
    const PTO_TYPES = ['PTO ‚Äì Vacation','PTO ‚Äì Sick','PTO ‚Äì Holiday','PTO ‚Äì Personal','PTO ‚Äì Other'];

    function newRowData(isPTO=false){
      return {
        type: isPTO ? 'PTO ‚Äì Vacation' : 'Work',
        employee:'', job:'', location:'',
        in:'', out:'', breakMin:0, breakStart:'', // breakStart stores a 12h string while running
        hours:'', notes:''
      };
    }

    // keep track of live break timers per row index
    const breakTimers = new Map(); // idx -> intervalId

    function renderTable(rows){
      // clear any live timers
      for(const id of breakTimers.values()){ clearInterval(id); }
      breakTimers.clear();

      el.body.innerHTML='';
      rows.forEach((r, idx)=>el.body.appendChild(renderRow(r, idx)));
      recalcAll();
    }

    function renderRow(r, idx){
      const tr=document.createElement('tr');
      tr.innerHTML=`
        <td>
          <select aria-label="Type">
            <option value="Work" ${r.type==='Work'?'selected':''}>Work</option>
            ${PTO_TYPES.map(t=>`<option value="${t}" ${r.type===t?'selected':''}>${t}</option>`).join('')}
          </select>
        </td>
        <td><input placeholder="Employee" value="${r.employee||''}" aria-label="Employee"></td>
        <td><input placeholder="Job" value="${r.job||''}" aria-label="Job"></td>
        <td><input placeholder="Location" value="${r.location||''}" aria-label="Location"></td>
        <td>
          <div class="miniWrap">
            <input placeholder="9:00 AM" value="${r.in||''}" aria-label="Time In">
            <div class="miniBtns">
              <button class="mini blue" title="Clock In Now">In</button>
            </div>
          </div>
        </td>
        <td>
          <div class="miniWrap">
            <input placeholder="5:00 PM" value="${r.out||''}" aria-label="Time Out">
            <div class="miniBtns">
              <button class="mini blue" title="Clock Out Now">Out</button>
            </div>
          </div>
        </td>
        <td>
          <div class="miniWrap">
            <div style="display:flex;gap:6px;align-items:center;flex-wrap:wrap;">
              <input type="number" min="0" step="1" placeholder="0" value="${r.breakMin||0}" style="width:90px" aria-label="Break minutes">
              <span class="badge" data-breakdisp>${r.breakStart ? 'Running 00:00' : '00:00'}</span>
            </div>
            <div class="miniBtns">
              <button class="mini" title="Start Break">Start</button>
              <button class="mini" title="End Break">End</button>
            </div>
          </div>
        </td>
        <td><input data-hours ${r.type==='Work'?'readonly':''} value="${r.hours||''}" tabindex="-1" aria-label="Hours"></td>
        <td><input placeholder="Notes" value="${r.notes||''}" aria-label="Notes"></td>
        <td>
          <div class="miniBtns">
            <button class="mini" title="Duplicate Row">Dup</button>
          </div>
        </td>
        <td><button class="del" title="Delete Row">‚úñ</button></td>
      `;

      const tSel = tr.querySelector('td:nth-child(1) select');
      const [emp, job, loc, tin, tout] = [
        tr.querySelector('td:nth-child(2) input'),
        tr.querySelector('td:nth-child(3) input'),
        tr.querySelector('td:nth-child(4) input'),
        tr.querySelector('td:nth-child(5) input'),
        tr.querySelector('td:nth-child(6) input'),
      ];
      const brkInput = tr.querySelector('td:nth-child(7) input');
      const brkDisp = tr.querySelector('[data-breakdisp]');
      const brkStartBtn = tr.querySelector('td:nth-child(7) .miniBtns button:nth-child(1)');
      const brkEndBtn = tr.querySelector('td:nth-child(7) .miniBtns button:nth-child(2)');
      const hrs = tr.querySelector('[data-hours]');
      const notes = tr.querySelector('td:nth-child(9) input');
      const inNow = tr.querySelector('td:nth-child(5) .miniBtns button');
      const outNow = tr.querySelector('td:nth-child(6) .miniBtns button');
      const dupBtn = tr.querySelector('td:nth-child(10) .miniBtns button');
      const delBtn = tr.querySelector('td:last-child .del');

      /* PTO vs Work toggle */
      function applyTypeUI(){
        const isWork = (tSel.value==='Work');
        tin.disabled = !isWork;
        tout.disabled = !isWork;
        brkInput.disabled = !isWork;
        brkStartBtn.disabled = !isWork;
        brkEndBtn.disabled = !isWork;
        inNow.disabled = !isWork;
        outNow.disabled = !isWork;
        hrs.readOnly = isWork; // PTO: allow manual hours entry
        hrs.tabIndex = isWork ? -1 : 0;
        if(!isWork){
          stopBreakTimer(idx); // ensure off
          brkDisp.textContent = '00:00';
          tin.value=''; tout.value=''; // keep PTO simple
        }
      }
      applyTypeUI();

      /* Live break stopwatch */
      function startBreakTimer(){
        stopBreakTimer(idx);
        let startStr = now12h();
        // if previously started, resume from that
        if(r.breakStart){ startStr = r.breakStart; }
        const startMin = parse12h(startStr);
        if(startMin==null) return;
        r.breakStart = startStr;
        brkDisp.textContent = 'Running 00:00';
        const id = setInterval(()=>{
          const nowMin = parse12h(now12h());
          if(nowMin==null) return;
          let diff = nowMin - startMin;
          if(diff<0) diff += 1440;
          const mm = Math.floor(diff);
          const m = Math.floor(mm/60), s = mm%60;
          const mmStr = ('0'+Math.floor(diff/60)).slice(-2);
          const ssStr = ('0'+(diff%60)).slice(-2);
          brkDisp.textContent = `Running ${mmStr}:${ssStr}`;
        }, 1000);
        breakTimers.set(idx, id);
      }
      function stopBreakTimer(i){
        if(breakTimers.has(i)){ clearInterval(breakTimers.get(i)); breakTimers.delete(i); }
      }
      function endBreakTimer(){
        if(!r.breakStart){ return; }
        const startMin = parse12h(r.breakStart);
        const endMin = parse12h(now12h());
        if(startMin!=null && endMin!=null){
          let diff = endMin - startMin;
          if(diff<0) diff += 1440;
          brkInput.value = (parseInt(brkInput.value,10)||0) + diff; // add minutes
        }
        r.breakStart = '';
        brkDisp.textContent = '00:00';
        stopBreakTimer(idx);
      }

      // if row had active start saved, resume timer
      if(r.breakStart){ startBreakTimer(); }

      /* sync to storage + recalc */
      function sync(save=true){
        const rows=getRows();
        rows[idx]={
          type: tSel.value,
          employee: emp.value.trim(),
          job: job.value.trim(),
          location: loc.value.trim(),
          in: tin.value.trim(),
          out: tout.value.trim(),
          breakMin: +brkInput.value||0,
          breakStart: r.breakStart || '',
          hours: hrs.value.trim(),
          notes: notes.value.trim()
        };
        if(save){ saveDay(el.date.value, rows); }
        recalcRow(tr, rows[idx]);
        renderTotals();
      }

      /* Events */
      [tSel,emp,job,loc,tin,tout,brkInput,notes,hrs].forEach(inp=>inp.addEventListener('input', ()=>sync(true)));

      inNow.addEventListener('click', ()=>{ tin.value = now12h(); sync(true); });
      outNow.addEventListener('click', ()=>{ tout.value = now12h(); sync(true); });

      brkStartBtn.addEventListener('click', ()=>{
        if(tSel.value!=='Work') return;
        r.breakStart = r.breakStart || now12h();
        startBreakTimer();
        sync(false);
      });
      brkEndBtn.addEventListener('click', ()=>{
        if(tSel.value!=='Work') return;
        endBreakTimer();
        sync(true);
      });

      dupBtn.addEventListener('click', ()=>{
        const rows = loadDay(el.date.value);
        const curr = rows[idx];
        rows.splice(idx+1, 0, {...curr, breakStart:'', hours:curr.type==='Work'?'':curr.hours});
        saveDay(el.date.value, rows);
        renderTable(rows);
      });

      delBtn.addEventListener('click', ()=>{
        stopBreakTimer(idx);
        const rows=getRows().filter((_,i)=>i!==idx);
        saveDay(el.date.value, rows);
        renderTable(rows);
        renderTotals();
      });

      return tr;
    }

    function getRows(){
      const rows=[];
      el.body.querySelectorAll('tr').forEach((tr, idx)=>{
        const tSel=tr.querySelector('td:nth-child(1) select');
        const tds=tr.querySelectorAll('td');
        rows.push({
          type: tSel.value,
          employee: tds[1].querySelector('input').value.trim(),
          job:      tds[2].querySelector('input').value.trim(),
          location: tds[3].querySelector('input').value.trim(),
          in:       tds[4].querySelector('input').value.trim(),
          out:      tds[5].querySelector('input').value.trim(),
          breakMin: +tds[6].querySelector('input').value || 0,
          breakStart: '', // not retrievable after render; managed live
          hours:    tds[7].querySelector('input').value.trim(),
          notes:    tds[8].querySelector('input').value.trim()
        });
      });
      return rows;
    }

    function recalcRow(tr, r){
      if(r.type!=='Work'){
        // PTO hours are manual
        return;
      }
      const mIn=parse12h(r.in), mOut=parse12h(r.out);
      let mins = (mIn!=null && mOut!=null) ? (mOut - mIn) : 0;
      if(mins<0) mins += 24*60; // cross-midnight safety
      mins -= (parseInt(r.breakMin,10)||0);
      if(mins<0) mins=0;
      tr.querySelector('[data-hours]').value = fmtHours(mins);
    }

    function recalcAll(){
      const rows=getRows();
      el.body.querySelectorAll('tr').forEach((tr,i)=>recalcRow(tr, rows[i]));
      renderTotals();
    }

    /* ---------- Totals by Employee ---------- */
    function renderTotals(){
      const rows=getRows();
      const map=new Map();
      rows.forEach(r=>{
        let mins=0;
        if(r.type==='Work'){
          const mIn=parse12h(r.in), mOut=parse12h(r.out);
          if(mIn==null||mOut==null) return;
          mins = mOut - mIn; if(mins<0) mins+=1440;
          mins -= (parseInt(r.breakMin,10)||0);
          if(mins<0) mins=0;
        }else{
          const h = parseFloat(r.hours)||0;
          mins = Math.round(h*60);
        }
        const key = (r.employee||'').trim() || '(No name)';
        if(!map.has(key)) map.set(key, []);
        map.get(key).push({job:r.job||'', location:r.location||'', type:r.type, mins});
      });

      el.totals.innerHTML='';
      for(const [emp, items] of map.entries()){
        const totalM = items.reduce((a,b)=>a+b.mins,0);
        const card=document.createElement('div');
        card.className='card';
        card.innerHTML=`<h4>${emp}</h4>
          <div class="row"><div>Total Hours</div><div><strong>${fmtHours(totalM)}</strong></div></div>
          ${items.map(x=>`<div class="row"><div>${x.type==='Work'?`${x.job||'(no job)'} @ ${x.location||'(no location)'}`
            : x.type}</div><div>${fmtHours(x.mins)} h</div></div>`).join('')}
        `;
        el.totals.appendChild(card);
      }
      if(map.size===0){
        const none=document.createElement('div');
        none.className='card';
        none.innerHTML='<h4>No entries yet</h4><div class="row"><div>Add rows above to see totals.</div><div></div></div>';
        el.totals.appendChild(none);
      }
    }

    /* ---------- Add Rows ---------- */
    document.getElementById('tcAddRow').addEventListener('click', ()=>{
      const rows = loadDay(el.date.value);
      rows.push(newRowData(false));
      saveDay(el.date.value, rows);
      renderTable(rows);
    });
    document.getElementById('tcAddPTO').addEventListener('click', ()=>{
      const rows = loadDay(el.date.value);
      rows.push(newRowData(true));
      saveDay(el.date.value, rows);
      renderTable(rows);
    });

    /* ---------- Copy: Time Entries (TSV) ---------- */
    function copyText(text){
      if(navigator.clipboard && navigator.clipboard.writeText){
        return navigator.clipboard.writeText(text);
      }
      const ta=document.createElement('textarea');
      ta.value=text; ta.style.position='fixed'; ta.style.top='-1000px'; document.body.appendChild(ta);
      ta.focus(); ta.select();
      try{ document.execCommand('copy'); }catch(e){}
      document.body.removeChild(ta);
      return Promise.resolve();
    }
    function flash(btn, txt='‚úÖ Copied!'){
      const prev=btn.textContent;
      btn.textContent=txt; btn.style.background='#22c55e';
      setTimeout(()=>{ btn.textContent=prev; btn.style.background='linear-gradient(90deg,#0072ff,#00c6ff)'; }, 1800);
    }

    el.copy.addEventListener('click', ()=>{
      const header = ['Type','Employee','Job','Location','Time In','Time Out','Break (min)','Hours','Notes'];
      const lines=[header.join('\t')];
      el.body.querySelectorAll('tr').forEach(tr=>{
        const tSel=tr.querySelector('td:nth-child(1) select');
        const tds=tr.querySelectorAll('td');
        const row=[
          tSel.value,
          tds[1].querySelector('input').value,
          tds[2].querySelector('input').value,
          tds[3].querySelector('input').value,
          tds[4].querySelector('input').value,
          tds[5].querySelector('input').value,
          tds[6].querySelector('input').value,
          tds[7].querySelector('input').value,
          tds[8].querySelector('input').value,
        ].map(x=>String(x||'').replace(/\n/g,' '));
        lines.push(row.join('\t'));
      });
      copyText(lines.join('\n')).then(()=>flash(el.copy));
    });

    /* ---------- Copy: Daily Summary (TSV) ---------- */
    el.copySummary.addEventListener('click', ()=>{
      const rows=getRows();
      const out=[];
      out.push(['Employee','Job/Location or PTO Type','Hours'].join('\t'));
      const empMap=new Map();
      rows.forEach(r=>{
        const emp=(r.employee||'(No name)').trim();
        if(!empMap.has(emp)) empMap.set(emp, []);
        if(r.type==='Work'){
          const mIn=parse12h(r.in), mOut=parse12h(r.out);
          if(mIn==null||mOut==null) return;
          let mins=mOut-mIn; if(mins<0) mins+=1440;
          mins -= (parseInt(r.breakMin,10)||0);
          if(mins<0) mins=0;
          empMap.get(emp).push({label:`${r.job||'(no job)'} @ ${r.location||'(no location)'}`, hours: mins/60});
        }else{
          const h = parseFloat(r.hours)||0;
          empMap.get(emp).push({label:r.type, hours:h});
        }
      });
      for(const [emp, items] of empMap.entries()){
        if(items.length===0){ out.push([emp,'‚Äî','0'].join('\t')); continue; }
        items.forEach(it=>out.push([emp, it.label, it.hours.toFixed(2)].join('\t')));
      }
      copyText(out.join('\n')).then(()=>flash(el.copySummary));
    });

    /* ---------- Invoice ---------- */
    function openModal(){ el.modal.style.display='flex'; }
    function closeModal(){ el.modal.style.display='none'; }

    function applyInvSettings(){
      const s=loadInvSettings();
      el.invBiz.value = s.biz || '';
      el.invBizAddr.value = s.addr || '';
      el.invClient.value = s.client || '';
      el.invClientAddr.value = s.clientAddr || '';
      el.invClientEmail.value = s.clientEmail || '';
      el.invNumber.value = s.number || '';
      el.invDate.value = s.date || toYYYYMMDD(new Date());
      el.invTax.value = (s.taxPct==null)?'0':s.taxPct;
      if(s.logo){ el.invLogoPrev.src=s.logo; } else { el.invLogoPrev.removeAttribute('src'); }
    }
    function captureInvSettings(){
      const s={
        biz: el.invBiz.value.trim(),
        addr: el.invBizAddr.value.trim(),
        client: el.invClient.value.trim(),
        clientAddr: el.invClientAddr.value.trim(),
        clientEmail: el.invClientEmail.value.trim(),
        number: el.invNumber.value.trim(),
        date: el.invDate.value,
        taxPct: parseFloat(el.invTax.value)||0,
        logo: el.invLogoPrev.getAttribute('src')||''
      };
      saveInvSettings(s);
      return s;
    }
    el.invLogo.addEventListener('change', (e)=>{
      const file=e.target.files && e.target.files[0];
      if(!file) return;
      const reader=new FileReader();
      reader.onload=()=>{ el.invLogoPrev.src=reader.result; captureInvSettings(); };
      reader.readAsDataURL(file);
    });
    [el.invBiz, el.invBizAddr, el.invClient, el.invClientAddr, el.invClientEmail, el.invNumber, el.invDate, el.invTax].forEach(inp=>{
      inp.addEventListener('input', captureInvSettings);
      inp.addEventListener('change', captureInvSettings);
    });

    function buildInvoiceLines(){
      const rows=getRows();
      const groups=new Map(); // key: emp|job|loc|type
      rows.forEach(r=>{
        let hours=0;
        if(r.type==='Work'){
          const mIn=parse12h(r.in), mOut=parse12h(r.out);
          if(mIn==null||mOut==null) return;
          let mins=mOut-mIn; if(mins<0) mins+=1440;
          mins -= (parseInt(r.breakMin,10)||0);
          if(mins<0) mins=0;
          hours = mins/60;
        }else{
          hours = parseFloat(r.hours)||0;
        }
        const key=[r.employee||'(No name)', r.job||'(No job)', r.location||'(No location)', r.type].join('|');
        if(!groups.has(key)) groups.set(key, {emp:r.employee||'(No name)', job:r.job||'(No job)', loc:r.location||'(No location)', type:r.type, hours:0});
        groups.get(key).hours += hours;
      });
      return Array.from(groups.values());
    }

    function renderInvoice(){
      captureInvSettings();
      const lines = buildInvoiceLines();
      el.invBody.innerHTML='';
      lines.forEach(item=>{
        const tr=document.createElement('tr');
        tr.innerHTML=`
          <td style="padding:8px;border-top:1px solid #f1f5f9">${item.emp}</td>
          <td style="padding:8px;border-top:1px solid #f1f5f9">${item.job}</td>
          <td style="padding:8px;border-top:1px solid #f1f5f9">${item.loc}</td>
          <td style="padding:8px;border-top:1px solid #f1f5f9">${item.type}</td>
          <td style="padding:8px;border-top:1px solid #f1f5f9;text-align:right">${item.hours.toFixed(2)}</td>
          <td style="padding:8px;border-top:1px solid #f1f5f9;text-align:right">
            <input class="invRate" type="number" step="0.01" placeholder="0.00" style="width:100px;border:1px solid #e5e7eb;border-radius:8px;padding:6px 8px;text-align:right">
          </td>
          <td style="padding:8px;border-top:1px solid #f1f5f9;text-align:right"><span class="invAmt">0.00</span></td>
        `;
        const rateInput=tr.querySelector('.invRate');
        const amtSpan=tr.querySelector('.invAmt');
        function recalc(){
          const rate=parseFloat(rateInput.value)||0;
          const amt = rate * item.hours;
          amtSpan.textContent = money(amt);
          recalcTotals();
        }
        rateInput.addEventListener('input', recalc);
        el.invBody.appendChild(tr);
      });

      function recalcTotals(){
        let sub=0;
        el.invBody.querySelectorAll('.invAmt').forEach(s=>sub += parseFloat(s.textContent)||0);
        el.invSub.textContent = money(sub);
        const taxPct = parseFloat(el.invTax.value)||0;
        const taxAmt = sub * (taxPct/100);
        el.invTaxAmt.textContent = money(taxAmt);
        el.invTotal.textContent = money(sub + taxAmt);
      }
      recalcTotals();
      el.invTax.addEventListener('input', recalcTotals, {once:true});
    }

    function ensureInvoiceDefaults(){
      const s=loadInvSettings();
      if(!s.number){ s.number = String(Math.floor(1000 + Math.random()*9000)); }
      if(!s.date){ s.date = toYYYYMMDD(new Date()); }
      saveInvSettings(s);
    }

    el.invoiceBtn.addEventListener('click', ()=>{
      ensureInvoiceDefaults();
      applyInvSettings();
      renderInvoice();
      openModal();
    });
    el.close.addEventListener('click', closeModal);

    // Email Invoice
    el.email.addEventListener('click', ()=>{
      captureInvSettings();
      let body = `Invoice #: ${el.invNumber.value}\nDate: ${el.invDate.value}\nBusiness: ${el.invBiz.value}\n${el.invBizAddr.value}\n\nBill To:\n${el.invClient.value}\n${el.invClientAddr.value}\n\n`;
      el.invBody.querySelectorAll('tr').forEach(tr=>{
        const tds = tr.querySelectorAll('td');
        const emp = tds[0].innerText.trim();
        const job = tds[1].innerText.trim();
        const loc = tds[2].innerText.trim();
        const typ = tds[3].innerText.trim();
        const hrs = tds[4].innerText.trim();
        const rate = tr.querySelector('.invRate')?.value || '0.00';
        const amt = tr.querySelector('.invAmt')?.textContent || '0.00';
        body += `${emp} | ${job} @ ${loc} (${typ}) ‚Äî ${hrs}h √ó $${rate} = $${amt}\n`;
      });
      body += `\nSubtotal: $${el.invSub.textContent}\n`;
      const taxPct=parseFloat(el.invTax.value)||0;
      body += `Tax (${taxPct}%): $${el.invTaxAmt.textContent}\n`;
      body += `Total: $${el.invTotal.textContent}\n\nThank you,\n${el.invBiz.value}`;
      const subject = encodeURIComponent(`Invoice ${el.invNumber.value}`);
      const mailto = `mailto:${encodeURIComponent(el.invClientEmail.value||'')}?subject=${subject}&body=${encodeURIComponent(body)}`;
      window.location.href = mailto;
    });

    // Download PDF (fallback to Print)
    el.download.addEventListener('click', ()=>{
      captureInvSettings();
      const modalBox = el.invoiceBox;
      if(typeof html2pdf !== 'undefined'){
        const opt = { margin: 0.5, filename: (el.invNumber.value || 'invoice') + '.pdf', image: { type:'jpeg', quality:0.98 }, html2canvas: { scale: 2 }, jsPDF: { unit:'in', format:'letter', orientation:'portrait' } };
        html2pdf().set(opt).from(modalBox).save();
      }else{
        window.print();
      }
    });
    // Print (invoice only due to @media print)
    el.print.addEventListener('click', ()=>{ captureInvSettings(); window.print(); });

    /* ---------- Init ---------- */
    document.getElementById('tcAddRow').disabled = false;
    loadDate(new Date());

  })();
  </script>

  <!-- Schema (basic) -->
  <script type="application/ld+json">
  {
    "@context":"https://schema.org",
    "@type":"SoftwareApplication",
    "name":"Time Clock & Invoice Builder",
    "applicationCategory":"BusinessApplication",
    "operatingSystem":"WebBrowser",
    "description":"Track daily hours by employee, job, and location with live break stopwatch and PTO. Copy entries and summaries to Excel. Generate printable or downloadable PDF invoices. Data persists locally.",
    "softwareVersion":"3.0",
    "offers":{"@type":"Offer","price":"0","priceCurrency":"USD","availability":"https://schema.org/InStock"},
    "publisher":{"@type":"Organization","name":"Xecute The Vision"}
  }
  </script>
</section>
